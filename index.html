<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Friend Group Jeopardy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --jeopardy-blue: #001f3f;
      --jeopardy-blue-light: #0f3c7a;
      --jeopardy-gold: #facc15;
      --jeopardy-red: #ef4444;
      --jeopardy-bg: radial-gradient(circle at top, #023e8a, #020617 55%, #000 100%);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--jeopardy-bg);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      overflow-x: hidden;
    }

    h1 {
      margin: 8px 0 4px;
      text-align: center;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      font-weight: 800;
      font-size: clamp(1.6rem, 3vw, 2.4rem);
      text-shadow: 0 0 10px rgba(250, 204, 21, 0.7),
                   0 0 30px rgba(59, 130, 246, 0.7);
      animation: glow 3s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 5px rgba(250, 204, 21, 0.5),
                     0 0 12px rgba(59, 130, 246, 0.4);
      }
      to {
        text-shadow: 0 0 15px rgba(250, 204, 21, 0.9),
                     0 0 40px rgba(59, 130, 246, 0.9);
      }
    }

    .subtitle {
      margin-bottom: 10px;
      font-size: 0.9rem;
      opacity: 0.9;
      text-align: center;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      transition: transform 0.08s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    button:active {
      transform: scale(0.96);
      box-shadow: 0 0 0 rgba(0,0,0,0);
      filter: brightness(0.9);
    }

    .btn-secondary {
      background: #1f2937;
      color: #e5e7eb;
      box-shadow: 0 0 12px rgba(15, 118, 110, 0.4);
    }

    .btn-primary {
      background: var(--jeopardy-gold);
      color: #111827;
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.7);
    }

    .btn-danger {
      background: var(--jeopardy-red);
      color: #f9fafb;
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.7);
    }

    /* === LOBBY === */
    #lobby-screen, #game-screen {
      width: 100%;
      max-width: 980px;
    }

    #lobby-screen {
      margin-top: 24px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(0,0,0,0.95));
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.7);
    }

    #game-screen {
      display: none;
    }

    #lobby-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    #lobby-subtitle {
      font-size: 0.9rem;
      opacity: 0.85;
      margin-bottom: 16px;
    }

    #player-form {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    #player-name-input {
      flex: 1 1 200px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 8px 12px;
      font-size: 0.9rem;
      background: #020617;
      color: #f9fafb;
    }

    #player-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .player-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 0.85rem;
    }

    .player-chip button {
      padding: 0 6px;
      font-size: 0.75rem;
      box-shadow: none;
      background: transparent;
      color: #f97373;
    }

    #lobby-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    #lobby-footer small {
      opacity: 0.7;
      font-size: 0.8rem;
    }

    /* === CONTROLS BAR (GAME) === */
    #controls {
      margin: 4px 0 14px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }

    /* === BOARD === */
    #board-wrapper {
      position: relative;
      max-width: 980px;
      width: 100%;
      padding: 10px;
      border-radius: 18px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(0,0,0,0.95));
      box-shadow: 0 18px 45px rgba(0,0,0,0.7);
      overflow: hidden;
    }

    #board-wrapper::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.15), transparent 60%),
        radial-gradient(circle at bottom right, rgba(250,204,21,0.12), transparent 60%);
      opacity: 0.7;
      pointer-events: none;
    }

    #board {
      position: relative;
      display: grid;
      grid-template-columns: repeat(5, minmax(120px, 1fr));
      gap: 6px;
      z-index: 1;
    }

    .category, .cell {
      border-radius: 6px;
      text-align: center;
      padding: 12px 6px;
      box-sizing: border-box;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .category {
      background: linear-gradient(to bottom, #1d4ed8, #1e293b);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.06em;
      box-shadow: 0 6px 10px rgba(15, 23, 42, 0.8);
    }

    .cell {
      background: radial-gradient(circle at top, #1d4ed8, #020617);
      cursor: pointer;
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--jeopardy-gold);
      text-shadow: 0 0 5px rgba(250, 204, 21, 0.7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease,
                  filter 0.12s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    .cell::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(130deg, transparent 0%, rgba(255,255,255,0.25) 40%, transparent 80%);
      opacity: 0;
      transform: translateX(-100%);
      transition: transform 0.4s ease, opacity 0.3s ease;
      pointer-events: none;
    }

    .cell:hover::after {
      opacity: 1;
      transform: translateX(100%);
    }

    .cell:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.9);
      filter: brightness(1.1);
    }

    .cell.used {
      background: #020617;
      color: #4b5563;
      cursor: default;
      text-decoration: line-through;
      text-shadow: none;
      filter: grayscale(0.4);
    }

    .cell.daily-double::before {
      content: "★";
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 0.8rem;
      color: rgba(251, 191, 36, 0.9);
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.8);
    }

    /* === GENERIC BACKDROP / MODALS === */
    #modal-backdrop,
    #scoreboard-backdrop,
    #scoring-backdrop,
    #fj-wager-backdrop,
    #fj-question-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(0,0,0,0.97));
      display: none;
      justify-content: center;
      align-items: center;
      padding: 16px;
      box-sizing: border-box;
      z-index: 20;
      animation: fadeIn 0.2s ease-out;
    }

    #scoreboard-backdrop,
    #scoring-backdrop,
    #fj-wager-backdrop,
    #fj-question-backdrop {
      z-index: 30;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(1.02); }
      to { opacity: 1; transform: scale(1); }
    }

    #modal,
    #scoreboard-modal,
    #scoring-modal,
    #fj-wager-modal,
    #fj-question-modal {
      background: #020617;
      border-radius: 16px;
      max-width: 720px;
      width: 100%;
      padding: 18px 18px 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    #modal {
      background: radial-gradient(circle at top, #020617, #020617 40%, #020617);
      padding: 22px 20px 18px;
      max-width: 720px;
    }

    #modal-inner {
      position: relative;
      z-index: 1;
    }

    /* === CLUE MODAL === */
    #modal-category {
      font-size: 0.85rem;
      text-transform: uppercase;
      opacity: 0.8;
      margin-bottom: 4px;
      letter-spacing: 0.1em;
    }

    #modal-value {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--jeopardy-gold);
    }

    #modal-question {
      font-size: 1.5rem;
      margin-bottom: 18px;
      line-height: 1.35;
      text-align: center;
    }

    #modal-answer {
      font-size: 1.3rem;
      margin-bottom: 16px;
      display: none;
      color: var(--jeopardy-gold);
      text-align: center;
      animation: answerPop 0.32s ease-out;
    }

    @keyframes answerPop {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    #modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    #modal-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* === TIMER (REGULAR CLUES) === */
    #timer-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 120px;
    }

    #timer-label {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    #timer-bar,
    #fj-timer-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.5);
    }

    #timer-fill,
    #fj-timer-fill {
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #facc15, #ef4444);
      transform-origin: left center;
      transform: scaleX(0);
      transition: transform 0.1s linear;
    }

    /* === SCOREBOARD MODAL === */
    #scoreboard-title,
    #scoring-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    #scoreboard-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .scoreboard-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.9rem;
    }

    .scoreboard-row span:last-child {
      font-weight: 700;
      color: var(--jeopardy-gold);
    }

    #scoring-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
      justify-content: center;
    }

    .scoring-player-btn {
      font-size: 0.8rem;
      padding: 6px 10px;
    }

    #scoring-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* === FINAL JEOPARDY MODALS === */
    #fj-wager-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    #fj-wager-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .fj-wager-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.9rem;
    }

    .fj-wager-row input {
      width: 100px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 4px 8px;
      font-size: 0.85rem;
      background: #020617;
      color: #f9fafb;
    }

    #fj-wager-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }

    #fj-question-category {
      font-size: 0.85rem;
      text-transform: uppercase;
      opacity: 0.8;
      margin-bottom: 6px;
      letter-spacing: 0.1em;
    }

    #fj-question-text {
      font-size: 1.3rem;
      margin-bottom: 10px;
      text-align: center;
    }

    #fj-answer-text {
      font-size: 1.2rem;
      margin: 10px 0;
      text-align: center;
      color: var(--jeopardy-gold);
      display: none;
    }

    #fj-timer-label {
      font-size: 0.85rem;
      margin-top: 4px;
      margin-bottom: 6px;
      text-align: center;
      opacity: 0.9;
    }

    #fj-scoring-section {
      margin-top: 12px;
      display: none;
    }

    #fj-scoring-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .fj-scoring-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.9rem;
    }

    .fj-scoring-row select {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 4px 8px;
      font-size: 0.85rem;
      background: #020617;
      color: #f9fafb;
    }

    @media (max-width: 800px) {
      #board {
        grid-template-columns: repeat(3, minmax(90px, 1fr));
      }
      .category {
        font-size: 0.75rem;
      }
      .cell {
        font-size: 1.1rem;
        padding: 10px 4px;
      }
      #modal-question {
        font-size: 1.2rem;
      }
      #modal-answer {
        font-size: 1.1rem;
      }
      #fj-question-text {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <h1>JEOPARDY</h1>
  <div class="subtitle">
    Step 1: Add players & click "Play Jeopardy".<br />
    In game: Spacebar = Show/Hide answer, Esc = Close clue.
  </div>

  <!-- LOBBY SCREEN -->
  <div id="lobby-screen">
    <div id="lobby-title">Set Up Your Game</div>
    <div id="lobby-subtitle">
      Add as many players as you want. When you're ready, hit <strong>Play Jeopardy</strong>.
    </div>
    <div id="player-form">
      <input id="player-name-input" type="text" placeholder="Enter player name and press Add" />
      <button class="btn-primary" id="add-player-btn">Add Player</button>
    </div>
    <div id="player-list"></div>
    <div id="lobby-footer">
      <small>Tip: Refreshing the page will keep players, scores, and used questions until you hit "Reset Game".</small>
      <button class="btn-primary" id="start-game-btn" disabled>Play Jaopardy</button>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen">
    <div id="controls">
      <button class="btn-danger" id="reset-board">Reset Game</button>
      <button class="btn-secondary" id="shuffle-board">Shuffle Values</button>
      <button class="btn-primary" id="scoreboard-btn">Scoreboard</button>
      <button class="btn-primary" id="final-jeopardy-btn">Final Jeopardy</button>
      <button class="btn-secondary" id="toggle-sound">Sound: On</button>
    </div>

    <div id="board-wrapper">
      <div id="board"></div>
    </div>
  </div>

  <!-- CLUE MODAL -->
  <div id="modal-backdrop">
    <div id="modal">
      <div id="modal-inner">
        <div id="modal-category"></div>
        <div id="modal-value"></div>
        <div id="modal-question"></div>
        <div id="modal-answer"></div>
        <div id="modal-footer">
          <div id="timer-wrapper">
            <div id="timer-label">Timer</div>
            <div id="timer-bar">
              <div id="timer-fill"></div>
            </div>
          </div>
          <div id="modal-buttons">
            <button class="btn-secondary" id="toggle-answer">Show Answer (Space)</button>
            <button class="btn-danger" id="close-modal">Close (Esc)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCOREBOARD MODAL -->
  <div id="scoreboard-backdrop">
    <div id="scoreboard-modal">
      <div id="scoreboard-title">Scoreboard</div>
      <div id="scoreboard-list"></div>
      <button class="btn-secondary" id="scoreboard-close">Close</button>
    </div>
  </div>

  <!-- SCORING MODAL (WHO GOT IT RIGHT PER CLUE) -->
  <div id="scoring-backdrop">
    <div id="scoring-modal">
      <div id="scoring-title">Who answered correctly?</div>
      <div id="scoring-list"></div>
      <div id="scoring-footer">
        <button class="btn-secondary" id="scoring-no-points">No points awarded</button>
      </div>
    </div>
  </div>

  <!-- FINAL JEOPARDY WAGER MODAL -->
  <div id="fj-wager-backdrop">
    <div id="fj-wager-modal">
      <div id="fj-wager-title">Final Jeopardy Wagers</div>
      <div id="fj-wager-list"></div>
      <div id="fj-wager-footer">
        <button class="btn-secondary" id="fj-wager-cancel">Cancel</button>
        <button class="btn-primary" id="fj-wager-start">Start Final Jeopardy</button>
      </div>
    </div>
  </div>

  <!-- FINAL JEOPARDY QUESTION MODAL -->
  <div id="fj-question-backdrop">
    <div id="fj-question-modal">
      <div id="fj-question-category"></div>
      <div id="fj-question-text"></div>
      <div id="fj-answer-text"></div>
      <div id="fj-timer-label"></div>
      <div id="fj-timer-bar">
        <div id="fj-timer-fill"></div>
      </div>
      <div id="fj-scoring-section">
        <div id="fj-scoring-list"></div>
        <button class="btn-primary" id="fj-apply-scores">Apply Wagers & Close</button>
      </div>
      <div style="margin-top: 8px; text-align: right;">
        <button class="btn-secondary" id="fj-question-close">Close</button>
      </div>
    </div>
  </div>

  <script>
    // === STEP 1: EDIT YOUR GAME QUESTIONS HERE ===
    const gameData = [
      {
        category: "Furry Friends",
        clues: [
          { value: 100, question: "This spirited word was the original namesake of our late Willow?", answer: "America" },
          { value: 200, question: "This friend was allowed to live with Wade despite a known allergy", answer: "Reese" },
          { value: 300, question: "This Beverage doubles as the name of an amphibious friend that lived well beyond their lifespan", answer: "Pepsi" },
          { value: 400, question: "The eldest Meeks daughter is barred from ever owning this species of salt water dweller", answer: "Hermet Crab" },
          { value: 500, question: "This pair of pets was mourned via a toilet funeral and a beautiful notes app eulogy", answer: "Shampoo & Conditioner" }
        ]
      },
      {
        category: "General Lore",
        clues: [
          { value: 100, question: "You can find this frozen treat in any fridge - a favorite of Brad's", answer: "Peanut Butter Spoon" },
          { value: 200, question: "This chicken was the most important comfort of Jansen for months", answer: "Ah-ha-heo" },
          { value: 300, question: "Grammy's famous pool, known as the 'deepest pool in VB' has a depth of: ", answer: "10 feet" },
          { value: 400, question: "If you're Jansen in the bath, lay your headback, get your hair wet, and utter this phrase", answer: "AnyTahns" },
          { value: 500, question: "This mythical creature was the preferred identity of Mason's Driver's Ed Group Member", answer: "Vampire" }
        ]
      },
      {
        category: "Eww, Gross.",
        clues: [
          { value: 100, question: "Home of Wade in college, this was deemed the cleanest house in the municipality of Newport News, VA", answer: "The Corner House" },
          { value: 200, question: "To quell a dangerous fear of going number 2, reward Tanner with this early 2000's treat", answer: "A Wonderball" },
          { value: 300, question: "Kellyn famously shouted 'This isn't going to work anymore' while cleaning up this mess", answer: "Trigger's Diahrria" },
          { value: 400, question: "This colloquial Blue Angel term can be used to describe an exciting time for many (learned by Tracey on her date)", answer: "Squirters" },
          { value: 500, question: "This world-renowned protesting landmark was the receiptient of an upchuck", answer: "Tienanman Square" }
        ]
      },
      {
        category: "Family Geography",
        clues: [
          { value: 100, question: "This southern city was the childhood home of Mason", answer: "Atlanta, GA" },
          { value: 200, question: "This weekend bagel spot fed the bellys of this family many-a-time", answer: "Towson Hot Bagels" },
          { value: 300, question: "Growing up in Hawaii, Tracy learned this critical Island Skillset", answer: "Poi Ball Dancing" },
          { value: 400, question: "When Tracey was born, Pops was deployed defending America in this war", answer: "The Vietnam War" },
          { value: 500, question: "To save up for his European trip, Wade sold this precious item", answer: "His Silver Bars" }  
        ]
      },
      {
        category: "The Younger Years",
        clues: [
          { value: 100, question: "Tanner really caused a racket playing this sport in High School", answer: "Badminton" },
          { value: 200, question: "This youtube cover broke the internet when Wade and his brothers put on a flawless performance", answer: "Accepted Answers: Pompeii or The Lion Sleeps Tonight" },
          { value: 300, question: "A knock at the door in Towson may mean little Kellyn is playing this game", answer: "Orphan" },
          { value: 400, question: "This birthday theme was a favorite of Mason's growing up", answer: "Blue" },
          { value: 500, question: "This was Brad's favorite Disney ride as a child", answer: "Peter Pan" }
        ]
      }
    ];

    // === STEP 1B: FINAL JEOPARDY QUESTION ===
    const finalJeopardyConfig = {
      category: "Final Meeks Trivia",
      question: "Pre Dinner ____, Pre Dinner _____, Pre Dinner _____, Pre Dinner _____",
      answer: "Hopefully you guys sang that, rather than writing down dog 4 times"
    };

    // === STEP 2: BASIC SETTINGS ===
    const settings = {
      timerSeconds: 15,           // normal clue timer
      enableDailyDouble: true,
      soundEnabledByDefault: true,
      finalReadSeconds: 7,        // Final Jeopardy read time
      finalAnswerSeconds: 20      // Final Jeopardy answer time
    };

    // === GAME STATE + LOCALSTORAGE ===
    const STORAGE_KEY = "friendJeopardy_state_v2";

    const defaultGameState = {
      players: [],
      nextPlayerId: 1,
      usedCells: [],          // ["0-0", "1-2", ...]
      shuffleSeed: null,      // number or null
      gameStarted: false,
      finalJeopardyPlayed: false
    };

    let gameState = { ...defaultGameState };

    function loadGameStateFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        gameState = { ...defaultGameState, ...saved };
      } catch {}
    }

    function persistGameState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
    }

    function resetGameCompletely() {
      if (!confirm("Reset the entire game? This clears players, scores, and used questions.")) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }

    // === SOUND FX ===
    class SoundFX {
      constructor() {
        this.enabled = settings.soundEnabledByDefault;
        this.ctx = null;
      }

      ensureContext() {
        if (!this.ctx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          if (AC) this.ctx = new AC();
        }
      }

      playBeep({ frequency = 440, duration = 0.12, type = "square", volume = 0.2 } = {}) {
        if (!this.enabled) return;
        this.ensureContext();
        if (!this.ctx) return;

        const ctx = this.ctx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.frequency.value = frequency;
        osc.type = type;
        gain.gain.value = volume;
        osc.connect(gain);
        gain.connect(ctx.destination);

        const now = ctx.currentTime;
        osc.start(now);
        osc.stop(now + duration);
      }

      openClue() {
        this.playBeep({ frequency: 660, duration: 0.1, type: "square" });
      }

      showAnswer() {
        this.playBeep({ frequency: 520, duration: 0.1, type: "sine" });
      }

      dailyDouble() {
        this.playBeep({ frequency: 440, duration: 0.12, type: "square" });
        setTimeout(() => this.playBeep({ frequency: 660, duration: 0.12, type: "square" }), 130);
      }

      toggle() {
        this.enabled = !this.enabled;
      }
    }

    const sfx = new SoundFX();

    // === TIMER FOR REGULAR CLUES ===
    class ClueTimer {
      constructor(seconds, fillEl) {
        this.seconds = seconds;
        this.fillEl = fillEl;
        this.startTime = null;
        this.rafId = null;
      }

      start() {
        if (!this.fillEl) return;
        this.startTime = performance.now();
        this.fillEl.style.transform = "scaleX(1)";
        const totalMs = this.seconds * 1000;

        const tick = (now) => {
          const elapsed = now - this.startTime;
          const remainingRatio = Math.max(0, 1 - elapsed / totalMs);
          this.fillEl.style.transform = `scaleX(${remainingRatio})`;
          if (remainingRatio > 0) {
            this.rafId = requestAnimationFrame(tick);
          } else {
            this.stop();
            this.fillEl.style.transform = "scaleX(0)";
          }
        };

        this.rafId = requestAnimationFrame(tick);
      }

      stop() {
        if (this.rafId) cancelAnimationFrame(this.rafId);
        this.rafId = null;
        if (this.fillEl) {
          this.fillEl.style.transform = "scaleX(0)";
        }
      }
    }

    // === SEEDED RNG FOR SHUFFLE (PERSISTENT) ===
    function mulberry32(a) {
      return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    // === MAIN GAME LOGIC ===
    const JeopardyGame = (() => {
      const boardEl = document.getElementById("board");
      const modalBackdrop = document.getElementById("modal-backdrop");
      const modalCategory = document.getElementById("modal-category");
      const modalValue = document.getElementById("modal-value");
      const modalQuestion = document.getElementById("modal-question");
      const modalAnswer = document.getElementById("modal-answer");
      const toggleAnswerBtn = document.getElementById("toggle-answer");
      const closeModalBtn = document.getElementById("close-modal");
      const resetBoardBtn = document.getElementById("reset-board");
      const shuffleBoardBtn = document.getElementById("shuffle-board");
      const toggleSoundBtn = document.getElementById("toggle-sound");
      const timerFillEl = document.getElementById("timer-fill");

      const scoreboardBtn = document.getElementById("scoreboard-btn");
      const scoreboardBackdrop = document.getElementById("scoreboard-backdrop");
      const scoreboardList = document.getElementById("scoreboard-list");
      const scoreboardCloseBtn = document.getElementById("scoreboard-close");

      const scoringBackdrop = document.getElementById("scoring-backdrop");
      const scoringList = document.getElementById("scoring-list");
      const scoringNoPointsBtn = document.getElementById("scoring-no-points");

      const finalBtn = document.getElementById("final-jeopardy-btn");
      const fjWagerBackdrop = document.getElementById("fj-wager-backdrop");
      const fjWagerList = document.getElementById("fj-wager-list");
      const fjWagerCancelBtn = document.getElementById("fj-wager-cancel");
      const fjWagerStartBtn = document.getElementById("fj-wager-start");

      const fjQuestionBackdrop = document.getElementById("fj-question-backdrop");
      const fjQuestionCategory = document.getElementById("fj-question-category");
      const fjQuestionText = document.getElementById("fj-question-text");
      const fjAnswerText = document.getElementById("fj-answer-text");
      const fjTimerLabel = document.getElementById("fj-timer-label");
      const fjTimerFill = document.getElementById("fj-timer-fill");
      const fjScoringSection = document.getElementById("fj-scoring-section");
      const fjScoringList = document.getElementById("fj-scoring-list");
      const fjApplyScoresBtn = document.getElementById("fj-apply-scores");
      const fjQuestionCloseBtn = document.getElementById("fj-question-close");

      let currentCell = null;
      let currentClue = null;
      let answerVisible = false;
      let timer = new ClueTimer(settings.timerSeconds, timerFillEl);
      let dailyDoubleCellKey = null;
      let scoringPromptShown = false;

      let fjWagers = {};
      let fjTimerInterval = null;
      let fjStage = null;
      let fjStageTotal = 0;
      let fjStageRemaining = 0;

      function cellKey(colIndex, rowIndex) {
        return `${colIndex}-${rowIndex}`;
      }

      function getUsedCellsSet() {
        return new Set(gameState.usedCells || []);
      }

      function saveUsedCells(set) {
        gameState.usedCells = Array.from(set);
        persistGameState();
      }

      function pickDailyDouble(cells) {
        if (!settings.enableDailyDouble || cells.length === 0) {
          dailyDoubleCellKey = null;
          return;
        }
        const index = Math.floor(Math.random() * cells.length);
        const key = cellKey(cells[index].dataset.col, cells[index].dataset.row);
        dailyDoubleCellKey = key;
        cells[index].classList.add("daily-double");
      }

      function buildShuffledData() {
        const seed = gameState.shuffleSeed;
        if (seed == null) return gameData;
        const rng = mulberry32(seed);
        return gameData.map(col => {
          const cluesCopy = [...col.clues];
          for (let i = cluesCopy.length - 1; i > 0; i--) {
            const j = Math.floor(rng() * (i + 1));
            [cluesCopy[i], cluesCopy[j]] = [cluesCopy[j], cluesCopy[i]];
          }
          return { ...col, clues: cluesCopy };
        });
      }

      function renderBoard() {
        const usedSet = getUsedCellsSet();
        boardEl.innerHTML = "";

        // Categories
        gameData.forEach(col => {
          const catDiv = document.createElement("div");
          catDiv.className = "category";
          catDiv.textContent = col.category;
          boardEl.appendChild(catDiv);
        });

        const dataToRender = buildShuffledData();
        const maxClues = Math.max(...dataToRender.map(c => c.clues.length));
        const clueCells = [];

        for (let row = 0; row < maxClues; row++) {
          dataToRender.forEach((col, colIndex) => {
            const clue = col.clues[row];
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.dataset.col = colIndex;
            cell.dataset.row = row;

            if (clue) {
              cell.textContent = `$${clue.value}`;
              const key = cellKey(colIndex, row);
              if (usedSet.has(key)) {
                cell.classList.add("used");
              }
              cell.addEventListener("click", () => openClue(cell, clue, col.category));
              clueCells.push(cell);
            } else {
              cell.textContent = "";
              cell.style.visibility = "hidden";
            }
            boardEl.appendChild(cell);
          });
        }

        pickDailyDouble(clueCells);

        // Disable Final Jeopardy button if already played
        if (gameState.finalJeopardyPlayed) {
          finalBtn.disabled = true;
          finalBtn.textContent = "Final Jeopardy Done";
        }
      }

      function openClue(cell, clue, categoryName) {
        if (cell.classList.contains("used")) return;

        currentCell = cell;
        currentClue = clue;
        answerVisible = false;
        scoringPromptShown = false;
        modalAnswer.style.display = "none";
        toggleAnswerBtn.textContent = "Show Answer (Space)";

        modalCategory.textContent = categoryName;
        modalValue.textContent = `$${clue.value}`;
        modalQuestion.textContent = clue.question;
        modalAnswer.textContent = clue.answer;

        modalBackdrop.style.display = "flex";
        timer.stop();
        timer = new ClueTimer(settings.timerSeconds, timerFillEl);
        timer.start();

        const key = cellKey(cell.dataset.col, cell.dataset.row);
        if (settings.enableDailyDouble && key === dailyDoubleCellKey) {
          modalCategory.textContent += " — DAILY DOUBLE!";
          sfx.dailyDouble();
        } else {
          sfx.openClue();
        }
      }

      function openScoringModal() {
        if (!currentClue || gameState.players.length === 0) return;
        scoringList.innerHTML = "";
        gameState.players.forEach(p => {
          const btn = document.createElement("button");
          btn.className = "btn-primary scoring-player-btn";
          btn.textContent = `${p.name} +$${currentClue.value}`;
          btn.addEventListener("click", () => {
            p.score += currentClue.value;
            persistGameState();
            if (scoreboardBackdrop.style.display === "flex") renderScoreboard();
            closeScoringModal();
          });
          scoringList.appendChild(btn);
        });
        scoringBackdrop.style.display = "flex";
      }

      function closeScoringModal() {
        scoringBackdrop.style.display = "none";
      }

      function toggleAnswer() {
        if (!currentClue) return;
        answerVisible = !answerVisible;
        modalAnswer.style.display = answerVisible ? "block" : "none";
        toggleAnswerBtn.textContent = answerVisible ? "Hide Answer (Space)" : "Show Answer (Space)";
        if (answerVisible) {
          sfx.showAnswer();
          if (!scoringPromptShown && gameState.players.length > 0) {
            scoringPromptShown = true;
            openScoringModal();
          }
        }
      }

      function closeModal() {
        if (!currentCell) {
          modalBackdrop.style.display = "none";
          return;
        }
        modalBackdrop.style.display = "none";
        currentCell.classList.add("used");

        const usedSet = getUsedCellsSet();
        usedSet.add(cellKey(currentCell.dataset.col, currentCell.dataset.row));
        saveUsedCells(usedSet);

        timer.stop();
        currentCell = null;
        currentClue = null;
      }

      function shuffleBoard() {
        if (!confirm("Shuffle questions and reset which ones are used? Scores will stay.")) return;
        gameState.usedCells = [];
        gameState.shuffleSeed = (Date.now() & 0xffffffff);
        persistGameState();
        renderBoard();
      }

      function toggleSound() {
        sfx.toggle();
        toggleSoundBtn.textContent = `Sound: ${sfx.enabled ? "On" : "Off"}`;
      }

      function renderScoreboard() {
        scoreboardList.innerHTML = "";
        if (!gameState.players.length) {
          const p = document.createElement("div");
          p.textContent = "No players yet. Add players in the lobby screen.";
          p.style.opacity = "0.8";
          p.style.fontSize = "0.9rem";
          scoreboardList.appendChild(p);
          return;
        }
        const sorted = [...gameState.players].sort((a, b) => b.score - a.score);
        sorted.forEach(p => {
          const row = document.createElement("div");
          row.className = "scoreboard-row";
          const nameSpan = document.createElement("span");
          const scoreSpan = document.createElement("span");
          nameSpan.textContent = p.name;
          scoreSpan.textContent = p.score;
          row.appendChild(nameSpan);
          row.appendChild(scoreSpan);
          scoreboardList.appendChild(row);
        });
      }

      function openScoreboard() {
        renderScoreboard();
        scoreboardBackdrop.style.display = "flex";
      }

      function closeScoreboard() {
        scoreboardBackdrop.style.display = "none";
      }

      function handleKeydown(e) {
        if (modalBackdrop.style.display !== "flex") return;
        if (e.code === "Space") {
          e.preventDefault();
          toggleAnswer();
        } else if (e.key === "Escape") {
          closeModal();
        }
      }

      // === FINAL JEOPARDY FLOW ===
      function openFinalJeopardy() {
        if (!gameState.players.length) {
          alert("Add some players first!");
          return;
        }
        if (gameState.finalJeopardyPlayed) {
          alert("Final Jeopardy has already been played.");
          return;
        }

        fjWagers = {};
        fjWagerList.innerHTML = "";
        gameState.players.forEach(p => {
          const row = document.createElement("div");
          row.className = "fj-wager-row";
          const label = document.createElement("span");
          label.textContent = `${p.name} (score: ${p.score})`;
          const input = document.createElement("input");
          input.type = "number";
          const max = Math.max(0, p.score);
          input.min = 0;
          input.max = max;
          input.value = max; // default full wager
          input.id = `fj-wager-${p.id}`;
          row.appendChild(label);
          row.appendChild(input);
          fjWagerList.appendChild(row);
        });

        fjWagerBackdrop.style.display = "flex";
      }

      function startFinalJeopardy() {
        fjWagers = {};
        for (const p of gameState.players) {
          const input = document.getElementById(`fj-wager-${p.id}`);
          if (!input) continue;
          let v = parseInt(input.value, 10);
          if (isNaN(v) || v < 0) v = 0;
          const max = Math.max(0, p.score);
          if (v > max) v = max;
          fjWagers[p.id] = v;
        }

        fjWagerBackdrop.style.display = "none";
        openFinalQuestion();
      }

      function openFinalQuestion() {
        fjQuestionCategory.textContent = finalJeopardyConfig.category;
        fjQuestionText.textContent = finalJeopardyConfig.question;
        fjAnswerText.textContent = `Answer: ${finalJeopardyConfig.answer}`;
        fjAnswerText.style.display = "none";
        fjScoringSection.style.display = "none";
        fjTimerLabel.textContent = "";
        fjTimerFill.style.transform = "scaleX(0)";
        fjQuestionBackdrop.style.display = "flex";

        startFinalTimers();
      }

      function updateFJTimerUI() {
        const secondsLeft = Math.ceil(fjStageRemaining);
        if (fjStage === "read") {
          fjTimerLabel.textContent = `Reading time: ${secondsLeft}s`;
        } else if (fjStage === "answer") {
          fjTimerLabel.textContent = `Answer time: ${secondsLeft}s`;
        }
        const ratio = Math.max(0, fjStageRemaining / fjStageTotal);
        fjTimerFill.style.transform = `scaleX(${ratio})`;
      }

      function startFinalTimers() {
        fjStage = "read";
        fjStageTotal = settings.finalReadSeconds;
        fjStageRemaining = settings.finalReadSeconds;
        updateFJTimerUI();

        if (fjTimerInterval) clearInterval(fjTimerInterval);
        fjTimerInterval = setInterval(() => {
          fjStageRemaining -= 0.2;
          if (fjStageRemaining <= 0) {
            if (fjStage === "read") {
              fjStage = "answer";
              fjStageTotal = settings.finalAnswerSeconds;
              fjStageRemaining = settings.finalAnswerSeconds;
              updateFJTimerUI();
            } else {
              clearInterval(fjTimerInterval);
              fjTimerInterval = null;
              onFinalTimerComplete();
            }
          } else {
            updateFJTimerUI();
          }
        }, 200);
      }

      function onFinalTimerComplete() {
        fjTimerLabel.textContent = "Time's up!";
        fjTimerFill.style.transform = "scaleX(0)";
        fjAnswerText.style.display = "block";
        renderFinalScoring();
      }

      function renderFinalScoring() {
        fjScoringList.innerHTML = "";
        gameState.players.forEach(p => {
          const row = document.createElement("div");
          row.className = "fj-scoring-row";
          const label = document.createElement("span");
          label.textContent = `${p.name} (wagered $${fjWagers[p.id] || 0})`;

          const select = document.createElement("select");
          select.id = `fj-result-${p.id}`;
          [
            { value: "correct", label: "Correct (+wager)" },
            { value: "wrong", label: "Wrong (−wager)" },
            { value: "noanswer", label: "No change" }
          ].forEach(opt => {
            const o = document.createElement("option");
            o.value = opt.value;
            o.textContent = opt.label;
            select.appendChild(o);
          });

          row.appendChild(label);
          row.appendChild(select);
          fjScoringList.appendChild(row);
        });

        fjScoringSection.style.display = "block";
      }

      function applyFinalScores() {
        gameState.players.forEach(p => {
          const wager = fjWagers[p.id] || 0;
          const select = document.getElementById(`fj-result-${p.id}`);
          if (!select) return;
          const result = select.value;
          if (result === "correct") {
            p.score += wager;
          } else if (result === "wrong") {
            p.score -= wager;
          }
        });

        gameState.finalJeopardyPlayed = true;
        persistGameState();
        if (scoreboardBackdrop.style.display === "flex") renderScoreboard();
        fjQuestionBackdrop.style.display = "none";
        finalBtn.disabled = true;
        finalBtn.textContent = "Final Jeopardy Done";
      }

      function closeFinalQuestion() {
        if (fjTimerInterval) {
          clearInterval(fjTimerInterval);
          fjTimerInterval = null;
        }
        fjQuestionBackdrop.style.display = "none";
      }

      function init() {
        renderBoard();
        resetBoardBtn.addEventListener("click", resetGameCompletely);
        shuffleBoardBtn.addEventListener("click", shuffleBoard);
        toggleAnswerBtn.addEventListener("click", toggleAnswer);
        closeModalBtn.addEventListener("click", closeModal);
        modalBackdrop.addEventListener("click", (e) => {
          if (e.target === modalBackdrop) {
            closeModal();
          }
        });
        toggleSoundBtn.addEventListener("click", toggleSound);
        document.addEventListener("keydown", handleKeydown);
        toggleSoundBtn.textContent = `Sound: ${sfx.enabled ? "On" : "Off"}`;

        scoreboardBtn.addEventListener("click", openScoreboard);
        scoreboardCloseBtn.addEventListener("click", closeScoreboard);
        scoreboardBackdrop.addEventListener("click", (e) => {
          if (e.target === scoreboardBackdrop) closeScoreboard();
        });

        scoringNoPointsBtn.addEventListener("click", () => closeScoringModal());
        scoringBackdrop.addEventListener("click", (e) => {
          if (e.target === scoringBackdrop) closeScoringModal();
        });

        finalBtn.addEventListener("click", openFinalJeopardy);
        fjWagerCancelBtn.addEventListener("click", () => { fjWagerBackdrop.style.display = "none"; });
        fjWagerBackdrop.addEventListener("click", (e) => {
          if (e.target === fjWagerBackdrop) fjWagerBackdrop.style.display = "none";
        });
        fjWagerStartBtn.addEventListener("click", startFinalJeopardy);

        fjQuestionBackdrop.addEventListener("click", (e) => {
          if (e.target === fjQuestionBackdrop) closeFinalQuestion();
        });
        fjQuestionCloseBtn.addEventListener("click", closeFinalQuestion);
        fjApplyScoresBtn.addEventListener("click", applyFinalScores);
      }

      return { init };
    })();

    // === LOBBY SETUP ===
    function setupLobby() {
      const lobbyScreen = document.getElementById("lobby-screen");
      const gameScreen = document.getElementById("game-screen");
      const playerNameInput = document.getElementById("player-name-input");
      const addPlayerBtn = document.getElementById("add-player-btn");
      const playerListEl = document.getElementById("player-list");
      const startGameBtn = document.getElementById("start-game-btn");

      function renderLobbyPlayers() {
        playerListEl.innerHTML = "";
        gameState.players.forEach(p => {
          const chip = document.createElement("div");
          chip.className = "player-chip";
          const nameSpan = document.createElement("span");
          nameSpan.textContent = p.name;
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.textContent = "×";
          removeBtn.addEventListener("click", () => {
            gameState.players = gameState.players.filter(x => x.id !== p.id);
            persistGameState();
            renderLobbyPlayers();
          });
          chip.appendChild(nameSpan);
          chip.appendChild(removeBtn);
          playerListEl.appendChild(chip);
        });
        startGameBtn.disabled = gameState.players.length === 0;
      }

      function addPlayerFromInput() {
        const name = playerNameInput.value.trim();
        if (!name) return;
        gameState.players.push({ id: gameState.nextPlayerId++, name, score: 0 });
        playerNameInput.value = "";
        persistGameState();
        renderLobbyPlayers();
        playerNameInput.focus();
      }

      addPlayerBtn.addEventListener("click", addPlayerFromInput);
      playerNameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addPlayerFromInput();
        }
      });

      startGameBtn.addEventListener("click", () => {
        if (!gameState.players.length) return;
        gameState.gameStarted = true;
        persistGameState();
        lobbyScreen.style.display = "none";
        gameScreen.style.display = "block";
        JeopardyGame.init();
      });

      // Restore from state if game already started
      renderLobbyPlayers();
      if (gameState.gameStarted && gameState.players.length > 0) {
        lobbyScreen.style.display = "none";
        gameScreen.style.display = "block";
        JeopardyGame.init();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadGameStateFromStorage();
      setupLobby();
    });
  </script>
</body>
</html>
